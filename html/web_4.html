<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åœ–ç‰‡ä¸Šå‚³ - æ¢æŸ±ç‰†</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    h2 {
      margin: 20px 0;
    }
    .container {
      display: flex;
      flex-wrap: wrap;   /* å…è¨±è‡ªå‹•æ›è¡Œ */
      justify-content: center;
      margin: 20px;
      gap: 20px;         /* æ¯å€‹åˆ†å€ä¹‹é–“çš„é–“è· */
    }
    .section {
      flex: 1 1 100px;   /* é è¨­æœ€å° 300pxï¼Œæœƒè‡ªå‹•ç¸®æ”¾ */
      max-width: 350px;  /* é¿å…å¤ªå¯¬ */
      margin: 0;
      padding: 15px;
      border: 2px solid #ccc;
      border-radius: 10px;
      background-color: #f9f9f9;
      transition: border-color 0.3s, background-color 0.3s;
    }
    .section.dragover {
      border-color: #007bff;
      background-color: #eef6ff;
    }
    .preview {
      margin-bottom: 10px;
      min-height: 200px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      border: 1px dashed #aaa;
      border-radius: 8px;
      padding: 10px;
    }
    .image-wrapper {
      position: relative;
      display: inline-block;
    }
    .preview img {
      max-width: 100px;
      max-height: 100px;
      object-fit: contain;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    .delete-btn {
      position: absolute;
      top: -8px;
      right: -8px;
      background: rgba(255, 0, 0, 0.8);
      color: white;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 14px;
      line-height: 18px;
      text-align: center;
      cursor: pointer;
      display: none;
    }
    .image-wrapper:hover .delete-btn {
      display: block;
    }
    .upload-btn {
      display: block;
      margin: 10px auto 0 auto;
    }
    .action-btn {
      margin-top: 30px;
      padding: 12px 24px;
      font-size: 16px;
      background-color: #2a4d69;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    .action-btn:hover {
      background-color: #1d3557;
    }

    /* Modal (è‡ªè¨‚ç¢ºèªè¦–çª—) */
    .modal {
      display: none; 
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 10px;
      width: 300px;
      text-align: center;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      animation: fadeIn 0.3s;
    }
    .modal h3 {
      margin-bottom: 15px;
    }
    .modal button {
      margin-top: 10px;
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    .modal .confirm {
      background: #007bff;
      color: white;
    }
    .modal .cancel {
      background: #ccc;
      margin-left: 10px;
    }
    @keyframes fadeIn {
      from {opacity: 0;}
      to {opacity: 1;}
    }

    /* éŸ¿æ‡‰å¼è¨­å®š */
    @media (max-width: 600px) {
      .container {
        flex-direction: column;
        align-items: center;
      }
      .section {
        max-width: 90%;
      }
    }
    @media (min-width: 601px) and (max-width: 992px) {
      .section {
        flex: 1 1 calc(50% - 40px); /* å…©æ¬„ */
        max-width: 100%;
      }
    }
    @media (min-width: 993px) {
      .section {
        flex: 1 1 calc(33% - 40px); /* ä¸‰æ¬„ */
      }
    }
  </style>
</head>
<body>
  <h2>è«‹ä¸Šå‚³çµæ§‹ç‰©åœ–ç‰‡</h2>
  <div class="container">
    <div class="section" id="beam-section" 
         ondragover="allowDrop(event)" 
         ondragleave="removeHighlight(event)" 
         ondrop="handleDrop(event, 'preview-beam')">
      <h3>æ¢</h3>
      <div class="preview" id="preview-beam">æ‹–æ›³åœ–ç‰‡åˆ°é€™è£¡æˆ–ä½¿ç”¨ä¸‹æ–¹æŒ‰éˆ•ä¸Šå‚³</div>
      <input type="file" accept="image/*" multiple class="upload-btn" onchange="previewImages(event, 'preview-beam')">
    </div>

    <div class="section" id="column-section" 
         ondragover="allowDrop(event)" 
         ondragleave="removeHighlight(event)" 
         ondrop="handleDrop(event, 'preview-column')">
      <h3>æŸ±</h3>
      <div class="preview" id="preview-column">æ‹–æ›³åœ–ç‰‡åˆ°é€™è£¡æˆ–ä½¿ç”¨ä¸‹æ–¹æŒ‰éˆ•ä¸Šå‚³</div>
      <input type="file" accept="image/*" multiple class="upload-btn" onchange="previewImages(event, 'preview-column')">
    </div>

    <div class="section" id="wall-section" 
         ondragover="allowDrop(event)" 
         ondragleave="removeHighlight(event)" 
         ondrop="handleDrop(event, 'preview-wall')">
      <h3>ç‰†</h3>
      <div class="preview" id="preview-wall">æ‹–æ›³åœ–ç‰‡åˆ°é€™è£¡æˆ–ä½¿ç”¨ä¸‹æ–¹æŒ‰éˆ•ä¸Šå‚³</div>
      <input type="file" accept="image/*" multiple class="upload-btn" onchange="previewImages(event, 'preview-wall')">
    </div>
  </div>

  <button class="action-btn" onclick="openModal()">å¯Ÿçœ‹çµæœè©•ä¼°</button>

  <!-- è‡ªè¨‚ Modal -->
  <div id="myModal" class="modal">
    <div class="modal-content">
      <h3>ç¢ºå®šå·²ä¸Šå‚³å®Œæ‰€æœ‰åœ–ç‰‡ï¼Ÿ</h3>
      <button class="confirm" onclick="goToNext()">ç¢ºèª</button>
      <button class="cancel" onclick="closeModal()">å–æ¶ˆ</button>
    </div>
  </div>

  <script>
    // åˆå§‹åŒ–ï¼šå–å¾— userId ä¸¦å„²å­˜
  window.addEventListener('DOMContentLoaded', () => {
    fetch('https://your-backend-url/get_user_id')  // â† æ›æˆä½ çš„å¾Œç«¯ç¶²å€
      .then(response => response.json())
      .then(data => {
        const userId = data.userId;
        console.log("å–å¾—çš„ userId:", userId);
        localStorage.setItem('userId', userId);  // å„²å­˜åˆ° localStorage
      })
      .catch(error => {
        console.error("å–å¾— userId å¤±æ•—:", error);
      });
  });

  // ä½ å¯ä»¥åœ¨åœ–ç‰‡ä¸Šå‚³æ™‚é€™æ¨£å–å‡º userIdï¼š
  function getUserId() {
    return localStorage.getItem('userId');
  }
    function previewImages(event, previewId) {
      const files = event.target.files;
      appendFiles(files, previewId);
      event.target.value = ""; // å…è¨±é‡è¤‡é¸æ“‡åŒä¸€æª”æ¡ˆ
    }

    function appendFiles(files, previewId) {
      const preview = document.getElementById(previewId);
      if (preview.innerText.includes("æ‹–æ›³åœ–ç‰‡åˆ°é€™è£¡")) {
        preview.innerHTML = ""; // ç§»é™¤æç¤ºæ–‡å­—
      }
      Array.from(files).forEach(file => {
        if (file.type.startsWith("image/")) {
          const reader = new FileReader();
          reader.onload = function(e) {
            const wrapper = document.createElement("div");
            wrapper.classList.add("image-wrapper");

            const img = document.createElement("img");
            img.src = e.target.result;

            const delBtn = document.createElement("button");
            delBtn.innerHTML = "ğŸ—‘";
            delBtn.classList.add("delete-btn");
            delBtn.onclick = () => wrapper.remove();

            wrapper.appendChild(img);
            wrapper.appendChild(delBtn);
            preview.appendChild(wrapper);
          };
          reader.readAsDataURL(file);
        }
      });
    }

    function allowDrop(event) {
      event.preventDefault();
      event.currentTarget.classList.add("dragover");
    }

    function removeHighlight(event) {
      event.currentTarget.classList.remove("dragover");
    }

    function handleDrop(event, previewId) {
      event.preventDefault();
      event.currentTarget.classList.remove("dragover");
      const files = event.dataTransfer.files;
      appendFiles(files, previewId);
    }

    // è‡ªè¨‚å½ˆçª—
    function openModal() {
      document.getElementById("myModal").style.display = "flex";
    }
    function closeModal() {
      document.getElementById("myModal").style.display = "none";
    }
    async function goToNext() {
      try {
        const response = await fetch("http://localhost:5000/get_user_id");
        const result = await response.json();
        const userId = result.userId;
        localStorage.setItem("userId", userId);
        console.log("å·²å»ºç«‹ userId:", userId);
        window.location.href = "web_5.html";
      } catch (error) {
        console.error("å»ºç«‹ userId å¤±æ•—:", error);
        alert("ç³»çµ±å¿™ç¢Œï¼Œè«‹ç¨å¾Œå†è©¦ï¼");
      }
    }
    let userId = null;

  // å–å¾— userId
  fetch("http://localhost:5000/get_user_id")
    .then(res => res.json())
    .then(data => {
      userId = data.userId;
      console.log("å–å¾— userId:", userId);
    });

  const detectionTypeMap = {
    "preview-beam": "beam",
    "preview-column": "column",
    "preview-wall": "wall"
  };

  function previewImages(event, previewId) {
    const files = event.target.files;
    appendFiles(files, previewId);
    event.target.value = ""; // å…è¨±é‡è¤‡é¸æ“‡åŒä¸€æª”æ¡ˆ
  }

  function appendFiles(files, previewId) {
    const preview = document.getElementById(previewId);
    if (preview.innerText.includes("æ‹–æ›³åœ–ç‰‡åˆ°é€™è£¡")) {
      preview.innerHTML = ""; // ç§»é™¤æç¤ºæ–‡å­—
    }
    Array.from(files).forEach(file => {
      if (file.type.startsWith("image/")) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const wrapper = document.createElement("div");
          wrapper.classList.add("image-wrapper");

          const img = document.createElement("img");
          img.src = e.target.result;

          const delBtn = document.createElement("button");
          delBtn.innerHTML = "ğŸ—‘";
          delBtn.classList.add("delete-btn");
          delBtn.onclick = () => wrapper.remove();

          wrapper.appendChild(img);
          wrapper.appendChild(delBtn);
          preview.appendChild(wrapper);
        };
        reader.readAsDataURL(file);

        // âœ… ä¸Šå‚³åˆ°å¾Œç«¯
        const detectionType = detectionTypeMap[previewId];
        uploadToServer(file, detectionType);
      }
    });
  }

  function uploadToServer(file, detectionType) {
    if (!userId) {
      console.error("å°šæœªå–å¾— userIdï¼Œè«‹ç¨å¾Œå†è©¦");
      return;
    }

    const formData = new FormData();
    formData.append("file", file);
    formData.append("userId", userId);
    formData.append("detectionType", detectionType);
    formData.append("CE_state", "false"); // æš«ä¸ä¼°åƒ¹

    fetch("http://localhost:5000/image", {
      method: "POST",
      body: formData
    })
    .then(res => res.json())
    .then(data => {
      console.log("âœ… ä¸Šå‚³æˆåŠŸï¼š", data);
    })
    .catch(err => {
      console.error("âŒ ä¸Šå‚³å¤±æ•—ï¼š", err);
    });
  }

  function allowDrop(event) {
    event.preventDefault();
    event.currentTarget.classList.add("dragover");
  }

  function removeHighlight(event) {
    event.currentTarget.classList.remove("dragover");
  }

  function handleDrop(event, previewId) {
    event.preventDefault();
    event.currentTarget.classList.remove("dragover");
    const files = event.dataTransfer.files;
    appendFiles(files, previewId);
  }

  function openModal() {
    document.getElementById("myModal").style.display = "flex";
  }

  function closeModal() {
    document.getElementById("myModal").style.display = "none";
  }

  async function goToNext() {
  await uploadImages();
  window.location.href = "web_5.html";
  }
  // âœ… å°‡ base64 è½‰ç‚º File ç‰©ä»¶
function dataURLtoFile(dataurl, filename) {
  const arr = dataurl.split(',');
  const mime = arr[0].match(/:(.*?);/)[1];
  const bstr = atob(arr[1]);
  let n = bstr.length;
  const u8arr = new Uint8Array(n);
  while (n--) u8arr[n] = bstr.charCodeAt(n);
  return new File([u8arr], filename, { type: mime });
}

// âœ… ä¸Šå‚³æ‰€æœ‰åœ–ç‰‡åˆ° /image API
async function uploadImages() {
  const userId = localStorage.getItem('userId');
  if (!userId) {
    alert("æ‰¾ä¸åˆ° userIdï¼Œè«‹é‡æ–°æ•´ç†é é¢");
    return;
  }

  const detectionTypes = ['beam', 'column', 'wall'];
  const CE_state = true;
  const CE_ratio = 0.3;

  for (const type of detectionTypes) {
    const preview = document.getElementById(`preview-${type}`);
    const wrappers = preview.querySelectorAll('.image-wrapper img');

    for (const img of wrappers) {
      const file = dataURLtoFile(img.src, `${type}_${Date.now()}.jpg`);
      const formData = new FormData();
      formData.append('file', file);
      formData.append('userId', userId);
      formData.append('detectionType', type);
      formData.append('CE_state', CE_state.toString());
      formData.append('CE_ratio', CE_ratio.toString());

      try {
        const res = await fetch('https://your-backend-url/image', {
          method: 'POST',
          body: formData
        });
        const result = await res.json();
        console.log(`ä¸Šå‚³ ${type} æˆåŠŸ:`, result);
      } catch (err) {
        console.error(`ä¸Šå‚³ ${type} å¤±æ•—:`, err);
      }
    }
  }
}
  </script>
</body>
</html>
